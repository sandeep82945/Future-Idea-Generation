The success of automated medical image analysis depends on large-scale and expert-annotated training sets. Unsupervised domain adaptation (UDA) has been raised as a promising approach to alleviate the burden of labeled data collection. However, they generally operate under the closed-set adaptation setting assuming an identical label set between the source and target domains, which is over-restrictive in clinical practice where new classes commonly exist across datasets due to taxonomic inconsistency. While several methods have been presented to tackle both domain shifts and incoherent label sets, none of them take into account the common characteristics of the two issues and consider the learning dynamics along network training. In this work, we propose optimization trajectory distillation, a unified approach to address the two technical challenges from a new perspective. It exploits the lowrank nature of gradient space and devises a dual-stream distillation algorithm to regularize the learning dynamics of insufficiently annotated domain and classes with the external guidance obtained from reliable sources. Our approach resolves the issue of inadequate navigation along network optimization, which is the major obstacle in the taxonomy adaptive cross-domain adaptation scenario. We evaluate the proposed method extensively on several tasks towards various endpoints with clinical and open-world significance. The results demonstrate its effectiveness and improvements over previous methods. Code is available at https://github.com/camwew/TADA-MI. 1. introduction Automated and objective analysis of medical images is an important research topic and has been explored in various clinical applications [65, 15]. To relieve the burden of acquiring massive annotated data for model development on new domains, several unsupervised domain adapta-
tion (UDA) methods [7, 43, 42] are proposed to mitigate the data distribution bias [57] between a richly labeled source domain and a target domain with no explicit supervision. However, these works assume a closed-set adaptation setting that the source and target domains should necessarily share the identical category label space and definition [49]. The restriction limits their practical applicability in the clinical wild [17]. Unlike natural images where the definitions of different entity categories (e.g., cat v.s. dog) are structured and globally unified, in the medical domain, inconsistency in taxonomy across different countries or institutes is a common issue compromising the feasibility of cross-domain adaptation [14]. Take nuclei recognition in histology images as an example, the ambiguous biologi-
ar X
iv :2
30 7. 14 70
9v 1
[ cs
.C V
] 2
7 Ju
l 2 02
cal characteristics of cells and distinct clinical usages of the analysis outcomes result in a lack of a unified categorization schema [17, 22]. With specific clinical purposes and downstream applications, different datasets could categorize nuclei with disparate granularities of biological concepts. Besides, as medical research evolves rapidly, novel cell and disease classes could be discovered and form datasets with continually expanding category label sets [46]. This motivates us to develop a generalized adaptation method with the capability to tackle both data distribution bias and category gap for more flexible UDA in clinical practice. To this end, we study the problem of taxonomy adaptive domain adaptation [21]. It assumes the target domain could adopt a label space different from the source domain. Following UDA, a labeled source dataset and unlabeled samples from the target domain are available during training. Additionally, to recognize the novel/fine-grained categories which are non-existent or unspecified in the source domain, a few samples of those target-private categories are annotated and utilized as exemplars. The technical challenge for this setting lies in how to alleviate domain shifts and concurrently learn new classes with very limited supervision. Recently, several methods are proposed towards a similar goal [35, 24]. However, they typically address the two issues individually in separate contexts and fail to design a unified paradigm according to their common characteristics [21], which could incur a subtle collision across issues since their objectives are non-relevant [68]. Besides, existing works either focus on cross-domain/class alignment in the feature space [45, 40] or resort to model output-based regularization such as self-supervision [50], whereas those approaches suffer from the equilibrium challenge of adversarial learning [1] and the low-quality pseudo-labels [62]. In this work, we present a unified framework for taxonomy adaptive cross-domain adaptation from a new perspective, i.e., via optimization trajectory distillation. Our strategy is motivated by a common challenge existing in both cross-domain and small-data learning regimes, which is the inadequate navigation in the course of network optimization. For cross-domain learning, the unstable feature alignment procedure and noisy pseudo-labels tend to induce error accumulation along network training [71]. Similarly, with limited support samples in new class learning, the optimization of network is inclined to step towards restricted local minima and cannot cover a globally-generalizable space [63]. To this end, we propose to exploit the optimization trajectory from a reliable “teacher” to provide external guidance for regularizing the learning dynamics of insufficiently annotated domain and classes, as illustrated in Fig. 1(b). Our method consists of two key components, i.e., crossdomain/class distillation and historical self-distillation. (i) Cross-domain and cross-class distillation aim to leverage the optimization trajectory from the richly labeled do-
main and classes to serve as the “teacher”. Motivated by the Neural Tangent Kernel (NTK) theory [29], we characterize the network optimization trajectory through gradient statistics. Then, given the observation that the subspace spanned by the gradients from most iterations is generally low-rank [39, 2], we design a gradient projection approach to suppress the noisy signals in stochastic gradients and rectify the distillation process. Thereafter constraints are imposed on the gradient statistics of target domain and new classes to calibrate their training dynamics towards domain-invariant and unbiased learning procedure. (ii) Historical self-distillation further drives the optimization paths of model to converge towards flat minima. It is found that the flatness of loss landscapes is strongly related to the model’s robustness and generalizability [28], while how to take advantage of the insight to tackle domain shifts and limited supervision is under-explored. We propose to exploit the historical gradients to construct the informative low-rank subspaces and then perform gradient projection to alleviate loss sharpness. It compensates for the intense and out-of-order optimization updates incurred by inadequate regularization and leads to better generalization. Our prime contributions are as follows: (1) We introduce a more generalized cross-domain adaptation paradigm for medical image analysis in which both data distribution bias and category gap exist across the source and target domains. (2) We leverage insights from recent learning theory research and propose a novel dual-stream optimization trajectory distillation method to provide external navigation in network training. We perform theoretical justifications from two perspectives to illustrate the merits of our method. (3) Experiments on various benchmarks validate the effectiveness and robustness of our proposed method and its improvements over existing approaches. 2. related works Domain Adaptation Domain adaptation (DA) aims to mitigate the data distribution bias [18]. The classic semisupervised/unsupervised DA focuses on the scenario where the target domain has an identical label space to the source domain [53, 16, 36]. The over-restricted precondition cannot suffice the demand of clinical usages [66]. There exist several efforts to take a step further than the closed-set adaptation, such as open-set DA [49] and universal DA [67]. However, the aim of those works is solely to detect the previously unseen classes, instead of learning to separately identify each new class with few supports. Some recent studies suggest to explicitly recognize the target-private categories. [35] performs feature projection and alignment based on the prototypical networks [56]. [21] combines pseudo-labeling and contrastive learning to combat domain bias and label gap. Nevertheless, those works are limited to tackling the two issues individually, which fails to exploit
their common characteristics and propose a unified solution. Cross-Domain Few-Shot Learning The technical challenge we need to resolve is similar to an emerging research topic, i.e., cross-domain few-shot learning [24]. The mainstream methods for this challenge include self-training [50, 27, 69], contrastive learning [13, 21], feature alignment/augmentation [60, 8, 26], and channel transformation [38, 44]. Those methods either focus on feature-level modulation or turn to output-level self-supervision and finetuning, which could bring instability along optimization [1, 62]. In this work, we propose a novel gradient-based framework to transfer knowledge in both cross-domain and few-shot settings. It implicitly characterizes the information in both feature space and output space. Gradient Manipulation In current deep learning systems where gradient descent serves as the most popular training algorithm, the directions and amplitudes of network optimization steps are embedded in the gradient space [9]. Gradient manipulation refers to directly modulating the optimization gradients for improved learning process [47]. Recently, it is introduced to mitigate the data distribution shift and shows promises in UDA and domain generalization [16, 19, 55]. However, those works are still restricted by the closed-set condition and do not consider the low-rank nature of gradients [39], which make their approaches vulnerable to noises in the small-data learning regime. Flatness in Optimization In previous machine learning research, the connection between convergence to flat minima in optimization and model generalizability has long been established [25, 34]. Theoretical and empirical studies prove that the flatness of loss landscapes highly correlates with generalization capability [4]. [5] averages the network weights of multiple checkpoints to prompt generalization across domains. Different from their post-hoc averaging approach operating on fixed models, we propose to regularize the intermediate dynamics of network optimization to achieve flat minima. 3. method  3.1. problem statement The taxonomy adaptive cross-domain adaptation problem can be formalized as follows. There exists a labeled source dataset Ds = {(xs,ys)}, an unlabeled target dataset Dut = {(xut )}, and a few-shot labeled support set from the target domain Dlt = {(xlt,ylt)}. Samples from source and target datasets are drawn from different data distributions, i.e., xs ∼ Ps, xt ∼ Pt, Ps ̸= Pt. The label sets of source and target datasets are denoted as Cs and Ct. Due to the novel/fine-grained categories only existing in the target dataset, we have Cs ̸= Ct. The shared and target-private new classes are indicated as C = Cs ∩ Ct and Ĉ = Ct\C. We call C existing in both datasets as anchor classes since
they can be used as anchors to facilitate knowledge transfer. The goal is to train a model jointly on Ds,Dut ,Dlt which performs inferences on data from Pt with labels in Ct. 3.2. characterization of optimization trajectory The technical challenge for the identified problem lies in overcoming both domain shifts and overfitting incurred by scarce training samples. As discussed in Section 1, those issues could lead to unreliable navigation during neural network optimization [20, 10]. Therefore, we propose to distill the optimization trajectory knowledge from well-annotated sources to regularize the training dynamics of target domain and new classes. Recently, NTK theory [29] has been regarded as a tool to dictate the evolution of neural networks. For a network f parameterized by θ, its training dynamics can be described by a kernel K. Given a training set with N samples, the kernel can be defined as an N × N matrix with K(i, j; θ) = ∇θf(xi; θ)⊤ · ∇θf(xj ; θ), where xi and xj are two input samples. It indicates the strong correlations between the network’s optimization trajectory and the gradients w.r.t. its parameters. We thus propose to collect a set of intermediate gradients during training and capture their statistics to characterize the optimization trajectory. Specifically, the second-order Taylor expansion shows that:
f(x; θ) =f(x; θ∗) + (θ − θ∗)⊤ · ∇θf(x; θ∗)
+ 1
2 (θ − θ∗)⊤ · ∇2θf(x; θ∗) · (θ − θ∗)
+O(∥θ − θ∗∥2),
(1)
which motivates us to model the first- and second-order derivatives (Hessian) of f to represent its learning dynamics. We use the mean of gradients to indicate the first-order derivative and follow [30] to approximate the second-order derivative with gradient variances. 3.3. cross-domain and cross-class distillation Gradient-based optimization algorithms depend on a large number of update steps supervised by sufficient labeled data [52]. In domain-shifted and small-data regimes, those algorithms suffer from noisy update signals and overfitting, without guarantee to converge towards generalizable minima [24]. To this end, we propose to distill the training dynamics from the label-rich source domain and anchor classes to the target domain and new classes for external regularization by leveraging their intermediate gradients. We firstly compute the gradients g for each domain and class by backpropagating the obtained losses. With a general backbone F for feature extraction and a task-specific predictor C for sample-/pixel-wise classification, the individual gradients can be expressed as:
g := [ ∂L(C(F(x)), y) ∂θC1 , · · · , ∂L(C(F(x)), y) ∂θCw ], (2)
where L is the loss function, w indicates the total number of parameters in C, x and y are training data and the corresponding label. For unlabeled samples xut in the target dataset, online pseudo-labels ỹut are used for loss calculation. Then, as shown in Fig. 2, we aggregate the individuallevel gradients in a memory buffer and retrieve the domainand class-level gradient statistics to model the global firstand second-order derivatives. According to Section 3.2, for gradients w.r.t. domain/class π collected from a training set with nπ samples, we derive their mean and variance as:
gmπ = 1
nπ
∑nπ i=1 giπ, (3)
gvπ = 1 nπ − 1 ∑nπ i=1 (giπ − gmπ )2. (4)
Those metrics are measured for each domain and class separately. However, the gradients obtained from insufficiently annotated domain and classes are dubious and error-prone [63]. To alleviate the issue, we take inspiration from recent learning theory findings that stochastic gradients along the optimization steps are generally low-rank [39], which indicates that the optimization process is governed by the top gradient eigenspace. Specifically, we devise a gradient projection approach to suppress the noisy model update signals in particular to the target domain and new classes by projecting their gradients on the reliable subspaces identified by the source domain and anchor classes with sufficient supervision. Our approach involves three iterative steps, i.e., subspace construction, gradient projection, and gradient statistics matching. Firstly, to identify the principal eigenspace, we perform Singular Value Decomposition (SVD) on the aggregated gradients from the source domain and anchor classes. We denote gradients collected from source domain, target domain, anchor class, and new
class as gs, gt, gA, and gN . Given the sets of gradients Gs = [g1s , g 2 s , · · · , gKs ] and GA = [g1A, g2A, · · · , gKA ] stored in the memory buffer of volume K, we apply SVD:
Gs = UsΣsV ⊤ s , GA = UAΣAV ⊤ A , (5)
where U , V , and Σ contain left singular vectors ui, right singular vector vi, and non-negative singular values σi, respectively. To capture the overall characteristics, we use the gradients averaged along all anchor classes to represent GA. Next, we adopt the low-rank matrix approximation to select the top-r significant left singular vectors in Us and UA based on the following criteria:
∥(Gs)rs∥2F ≥ τ ∥Gs∥ 2 F , ∥(GA) rA∥2F ≥ τ ∥GA∥ 2 F , (6) where (G)r = ∑r
i=1 σ iuivi⊤, ∥·∥F denotes the Frobenius
norm, τ is a threshold to ensure most information is preserved and is set to 0.98. The principal subspace and the corresponding projection matrix are thereby constructed as Ms = [u 1 s,u 2 s, · · · ,urss ] and MA = [u1A,u2A, · · · ,u rA A ]. Afterward, all gradients are projected on the identified subspace as shown in Fig. 2:
g∗s = MsM ⊤ s gs, g ∗ t = MsM ⊤ s gt,
g∗A = MAM ⊤ A gA, g ∗ N = MAM ⊤ A gN . (7)
Then following Eq. (3)(4), we minimize the discrepancy between the statistics (i.e., mean and variance) of projected gradients to distill the learning dynamics from the source domain and anchor classes to the target domain and new classes. The overall training objective can be formulated as:
min θ LERM + λ
{ ∥(gm∗s − gm∗t )∥ 2 2 + ∥(g v∗ s − gv∗t )∥ 2 2
+ 1
nnew
∑nnew i=1 [ ∥(gm∗A − gm∗Ni )∥ 2 2 + ∥(g v∗ A − gv∗Ni)∥ 2 2 ]} . (8)
Here LERM denotes the empirical risk loss, which is implemented with cross-entropy loss for classification and Dice loss [48] for segmentation. λ is a balancing coefficient, nnew is the number of new classes in the target domain. It is noted that there exists discrepancy between the anchor and new classes in semantic concepts, which makes feature alignment across classes harmful due to negative transfer [64]. However, aligning class-wise learning dynamics by enforcing the similarity between their gradients could contribute to lower empirical error on new classes. We prove this property theoretically in the supplementary material. 3.4. historical self-distillation Inferior generalization behaviour is an outstanding challenge for taxonomy adaptive cross-domain adaptation [21]. When domain shifts and unseen classes exist, a trained model could only maintain its performance on test samples sharing multiple similar attributes with the training data but cannot generalize well to the disparate ones [72]. Motivated by the connection between flat minima and generalizability [34], we devise the historical self-distillation module to smooth the optimization path towards a well-generalizable solution by calibrating gradient descent steps. To reach flat loss landscapes [6], assuming a local loss function ψ and a network f parameterized by θ, instead of minimizing the original loss ψ(f(x; θ)) only, the optimization objective should be:
min θ − log ∫ ∥θ−θ∗∥≤Γ exp(−ψ(f(x; θ∗))−γ ∥θ − θ∗∥) dθ∗, (9) where x indicates random input samples, Γ is defined as the width of a local parameter valley, γ is a balancing weight. In other words, when θ and θ∗ are neighbouring, the following criteria is required to be satisfied:
∥∇θψ(f(x; θ))−∇θψ(f(x; θ∗))∥ ≤ β ∥θ − θ∗∥ , (10)
where β is a smoothness factor. To this end, we propose to impose regulations on the optimizer steps by enforcing minima with uniformly-distributed gradients. Given that the gradients from most iterations are generally lowrank [39, 2], we exploit past gradients to identify the lowdimensional subspace which indicates the principal gradient distribution of local minima and then project current gradients on the constructed subspace to exclude sharp and noisy signals. Specifically, we collect and store individual gradients for each iteration along the training procedure, denoted as GIt = [gt−TIt , g t−T+1 It , · · · , g t−2 It , g t−1 It ], where t is the index of current iteration, T is the size of memory buffer. Thereafter we perform SVD on the set of gradients GIt to construct the historical subspace. Similar to Eq. (5)(6)(7), the top-r left singular vectors of the decomposed gradient set are concatenated to formulate the projection matrix
MIt. Then for upcoming gradients obtained from backpropagation in each iteration, we project the gradients on the identified low-rank subspace and consider them as residuals. The subsequent optimizer step is conducted with the sum of the original and rectified gradients, as shown in Fig. 2. Take vanilla stochastic gradient descent as an example, with mini-batch gradients g̃ in each iteration, the parameters θ of the optimized network are updated by:
θ := θ − 1 κ · η · (MIt M⊤It + κ) · g̃, (11)
where η is the learning rate, κ is a trade-off parameter. As training proceeds, the principal subspace and the corresponding projection matrix are periodically renewed by applying SVD on the recently collected gradients. The overall training procedure is summarized in the supplementary material. 3.5. theoretical analysis In this section, we motivate our proposed method theoretically and provide mathematical insights on its merits. Joint Characterization of Feature and Output Space While our optimization trajectory distillation approach proposes a novel perspective that differs from existing works imposing regularization terms in feature and model-output space [35, 21], those information is still captured and implicitly modeled in the gradient-based framework. We prove this property for the classification and segmentation tasks under two commonly adopted loss functions. The detailed proof is presented in the supplemental material. It illustrates the superiority of our method as a unified framework that jointly characterizes the feature and output space as well as the learning dynamics. Impacts on Generalization Error In our method, we propose to minimize the discrepancy between the gradient statistics from different domains and classes in the identified principal subspace. We hereby prove its effectiveness towards a tighter generalization error bound on the target domain and new classes [3]. Details can be found in the supplemental material. 4. experiments  4.1. datasets and experiment settings To evaluate the effectiveness of our method and its potential clinical implications, we conduct experiments on five medical image datasets in regard to three important downstream tasks from different clinical scenarios. Extended experiments on more diverse tasks, including radiology and fundus analysis, as well as general visual task, are presented in the supplemental material to substantiate the broader applicability of our method. Nuclei Segmentation and Recognition Technically, this task can be formalized as a simultaneous instance segmentation and classification problem [23]. We evaluate our method by considering PanNuke [17] and Lizard [22] as the source and target datasets. They contain 481 and 291 visual fields cropped from whole-slide images with 189,744 and 495,179 annotated nuclei, respectively. There are six types of nuclei in Lizard and only two of them overlap with the five classes in PanNuke, which suggests four new classes in the target domain. We employ the widely used HoverNet [23] architecture with a standard ResNet-50 backbone as the base model. For quantitative evaluation, we follow [22] and report the average F1 and PQ (panoptic quality) scores for all classes (denoted as mF1 and mPQ) to provide a comprehensive assessment measuring the accuracy of nuclei detection, segmentation, and classification. Additionally, we also report the mF1* and mPQ* scores which are solely computed on new classes in the target domain. Cancer Tissue Phenotyping In this setting, we perform adaptation from a two-class discrimination task to an eightclass one on CRC-TP [31] and Kather [33] datasets. Kather consists of 5000 150×150 pathology image patches and includes six novel classes other than the two common classes also existing in the source domain. The experiments are conducted with ResNet-101 as backbone. For evaluation, we exploit the accuracy and F1 scores as metrics to indicate the classification performance. The average scores for all classes (mAcc and mF1) and particularly the ones on new classes only (mAcc* and mF1*) are reported. Skin Lesion Diagnosis We construct a fine-grained taxonomy adaptation setting from two coarse classes to seven subclasses with HAM10000 [59], which contains 10015 dermatoscopic images sampled from different body structures. The adopted experiment settings and evaluation metrics are the same as the cancer tissue phenotyping task. Since the label space of the source and target datasets do
not overlap, we only report the mAcc* and mF1* scores which are computed on target classes. Following previous works in UDA [7], for all experiments, each dataset is randomly split into 80%/20% for training/testing. To explicitly recognize the target-private new classes, we sample few (5/10) samples with corresponding labels to formulate the support set. The remaining target data is left unlabeled. More details can be found in the supplemental material. 4.2. results We compare our method with state-of-the-art approaches for cross-domain adaptation, including UDA methods DANN [18] and CGDM [16] which do not consider the taxonomic inconsistency, as well as LETR [45], FT-CIDA[35], STARTUP [50], DDN [27], TSA [38], and TACS [21] which are designed for both domain shifts and new class learning. For UDA methods, we jointly perform domain alignment and train the model with the labeled target data. In addition, we conduct comparisons with multi-task learning approach [54], which trains the model on all domains and label sets simultaneously. “Sup-only” indicates the baseline where only the supervised loss on the labeled target dataset is used for training. Table 1 shows the comparison results on the crossdomain nuclei recognition and segmentation task. All methods adopt the same ResNet-50-HoverNet as base model following [23]. It can be observed that our proposed method outperforms the state-of-the-art cross-domain adaptation approaches by a large margin. We also notice an important point that compared with the “Sup-only” baseline, most competing methods fail to attain better performance on the metrics specific to new classes (i.e., mF1* and mPQ*). For example, under the 5-shot setting, despite a 4.68% improvement is achieved by DANN on mF1, it achieves inferior performance on mF1* which is 4.94% worse than “Sup-only”. This phenomenon is incurred by the failure of cross-class generalization. In contrast, our method yields substantial improvements on those new class-specific metrics, which indicates the superior generalizability of our method. The observation is further verified through visual comparisons in the supplementary material. The overall quantitative results on the cancer tissue phenotyping and skin lesion diagnosis tasks are presented in Table 2 and 3, respectively. All methods are implemented based on the ResNet-101 backbone. Under each few-shot setting, our method shows higher classification scores compared with previous approaches. In particular, we achieve 0.62%∼5.32% and 1.12%∼4.81% improvements against the second-best results in terms of mAcc and mF1 for cancer tissue phenotyping, as well as 4.92%∼7.58% and 2.88%∼4.93% improvements in terms of mAcc* and mF1* for skin lesion diagnosis. The higher accuracy consistently attained by our method under different cross-domain adaptation settings and clinical tasks is attributed to the strong generalizability brought by the proposed optimization trajectory distillation approach. 4.3. analysis and discussion Ablation of Key Components Table 4 shows the ablation study results to illustrate the effectiveness of key components. “projection” denotes the gradient projection approach introduced in Section 3.3. For the “w/o projection” ablation, we perform cross-domain and cross-class distillation by directly minimizing the statistics discrepancy between unrectified gradients (gs, gt) and (gA, gN ) in Eq. (7). It is observed that each component is indispensable and could improve the overall performance, which elaborates the importance of external navigation for learning target domain and new classes in network training. Interestingly, we notice that the impacts of cross-domain and cross-class distillation could be disparate across tasks. For example, crossclass distillation brings higher performance gain compared with cross-domain distillation on the cancer tissue phenotyping benchmark, while the situation is reversed for skin lesion diagnosis. It is caused by the different natures of each task. Class-imbalance is a serious issue for skin lesion diagnosis in that the class distribution is highly biased [59], which compromises the effectiveness of the cross-class distillation module. Differently, for cancer tissue phenotyping, classes are uniformly distributed [33] and could hence ensure the representativity of anchor classes and their exemplarity to be distilled to new classes. Hyperparameter Sensitivity To investigate the effect of hyperparameters λ in Eq. (8) and κ in Eq. (11), we present the performance comparison by varying the choices of their values for cancer tissue phenotyping, as shown in Fig. 3. We only change one hyperparameter while keeping the other fixed at a time. The experimental results show that our framework is quite stable for hyperparameters in a wide interval, yet setting λ and κ to a large value is detrimental to the classification accuracy. Specifically, λ is a balancing coefficient between class discriminativeness and gradient alignment. When it is too large, the trained model is biased to matching learning dynamics and would lose es-
Table 4. Key component analysis of our method on three cross-domain adaptation benchmarks under 10-shot scheme. The best results are highlighted in bold. Methods Nuclei Cancer Skin
mF1 mF1* mPQ mPQ* mAcc mAcc* mF1 mF1* mAcc* mF1*
Full Framework 43.88 31.43 24.81 19.35 55.86 51.27 52.98 52.12 52.14 30.52 w/o cross-domain 39.96 30.08 22.29 18.10 52.81 49.93 51.62 50.64 44.34 25.28
w/o cross-class 42.30 27.82 23.76 17.05 48.90 47.22 49.85 44.76 49.06 28.24 w/o historical 41.54 30.47 23.00 17.59 50.17 48.05 48.19 45.12 45.83 25.97 w/o projection 40.06 28.80 22.10 17.31 53.58 45.78 49.01 49.20 47.29 28.02
Figure 3. Performance comparison between different choices of hyperparameters λ and κ on the cancer tissue phenotyping benchmark under 10-shot scheme. sential semantic knowledge. For κ, it controls the proportions of unrectified gradients. Its large value indicates that most original gradients are preserved, which would incur noisy optimization steps and loss of flatness. Therefore, we decide to set λ = 10 and κ = 100. It achieves the best performance under most metrics. Impacts on Optimization Trajectory and Model Flatness To better understand the effectiveness of our method, we perform in-depth analysis about its impacts on model’s training trajectory and flatness of the converged local minima. Firstly, as shown in Fig. 4(a), we visualize the optimization paths of our method and the multi-task baseline on the test accuracy surface with a contour plot. The details of plot procedure can refer to [28]. It can be observed that the optimization of the multi-task baseline fluctuates sharply and is restricted in a sub-optimal area with a relatively low test accuracy. This is induced by the biased navigation in the course of training due to domain shifts and category gap. With the devised dual-stream optimization trajectory distillation module, our method could by contrast suppress the noisy update signals and proceed consistently towards the optimum. Besides, we perform analysis about the solutions found by our method and the baseline in terms of flatness [5]. Specifically, the local flatness of a model parameter θ is quantified by the expected changes of test accuracy between θ and a neighbouring θ∗ with perturbation rate ϱ: Fϱ(θ) = E∥θ∗∥=(1+ϱ)∥θ∥ [ Acc(θ∗)− Acc(θ) ] . We approximate the expected value by Monte-Carlo sampling over 50 samples. As demonstrated in Fig. 4(b), comparing with the
baseline approach, our method shows stronger robustness against model parameter perturbation. It proves that our method successfully converges to minima with better local flatness and thus possesses superior generalizability [34]. 5. conclusion In this paper, we study the taxonomy adaptive crossdomain adaptation paradigm, which allows incoherent label sets between source and target datasets. To jointly address the data distribution bias and category gap, we propose a unified framework which performs cross-domain and cross-class optimization trajectory distillation to calibrate the learning dynamics of insufficiently annotated domain and classes. Historical self-distillation is further devised to attain a well-generalizable solution via regulating gradient distributions. Extensive experiments on multiple benchmarks with different task contexts demonstrate the effectiveness and generalization capability of our method. Supplementary Material: Taxonomy Adaptive Cross-Domain Adaptation in Medical Imaging via Optimization Trajectory Distillation
Jianan Fan1, Dongnan Liu1, Hang Chang2, Heng Huang3, Mei Chen4, and Weidong Cai1
1University of Sydney 2Lawrence Berkeley National Laboratory 3University of Maryland at College Park 4Microsoft jfan6480@uni.sydney.edu.au dongnan.liu@sydney.edu.au hchang@lbl.gov henghuanghh@gmail.com Mei.Chen@microsoft.com tom.cai@sydney.edu.au
In this supplementary, we provide additional illustration of our proposed method and proofs to support theoretical analysis, as well as dataset and implementation details. Extended experiments and analysis are performed to further verify the effectiveness and robustness of our method. 1. overall traininig procedure We summarize the workflow of our proposed method in Algorithm 1. The referred equation can be found in the main text. 2. details for theoretical analysis  2.1. joint characterization of feature and output Space
Here, we prove that in our gradient-based method, information in feature space and model-output space can be jointly modeled implicitly, which demonstrates the superiority of our method as a unified framework that jointly characterizes the feature and output space as well as the learning dynamics. We illustrate this property under cross-entropy loss and Dice loss. Specifically, for the task-specific prediction layer, which is implemented as a convolutional layer with 1 × 1 kernel, its function can be mathematically expressed as:
u = W⊤z + b, (12)
where z ∈ RB×m×h×w denotes the input feature maps with batch size B, channel number m, and spatial size h × w. W ∈ Rm×c is the convolutional kernel matrix with input channel m and output channel c. b ∈ Rc indicates the bias tensor. u ∈ RB×c×h×w is the logit predictions. We first consider the gradients for network parameter θ by backpropagating the cross entropy (CE) loss LCE :
min θ∼[W , b]
− p∑
n=1 c∑ i=1 yni log eu n i∑c j=1 e unj , (13)
Algorithm 1: Training Procedure for Optimization Trajectory Distillation
Input: Source dataset Ds, target dataset Dt, number of iterations I
Output: Optimized model parameters θ 1 Init: Gradient memory buffer Gs,GA,GIt 2 for i← 1 to I do 3 {(xs,ys)} ← Image-label pairs sampled from(Ds) 4 {(xut )}, {(xlt,ylt)} ← Sample from(Dt) 5 Generate online pseudo-label ỹut 6 {(xt,yt)} ← {(xut , ỹut ), (xlt,ylt)} 7 Backpropagate gradients gs, gt, gA, gN by Eq. (2) 8 Cross-domain/class distillation: 9 Update Gs and GA with gs and gA
10 if Gs andGA are full then 11 Apply SVD to identify the principal subspace and
form the corresponding projection matrix Ms,MA by Eq. (5)(6)
12 Clear Gs and GA 13 end 14 Perform gradient projection by Eq. (7) 15 Compute the overall training objective L by Eq. (8) 16 Temporal self-distillation: 17 Update GIt with gIt 18 if GIt is full then 19 Form the projection matrix MIt by Eq. (5)(6) 20 Clear GIt 21 end 22 Compute the mini-batch gradients g̃ ← ∇θL(θ) 23 Update model parameters θ by Eq. (11) 24 end  25 return θ where p = B × h × w is the total number of pixels, y ∈ RB×c×h×w is the one-hot pixel-wise class label. Since our focus is on feature space z and output space u, without loss of generality, we set y to follow the uniform class dis-
9
tribution that y = [1/c, 1/c, ..., 1/c]. Then, for each pixel, the derivative of the CE loss can be formulated as:
∂LCE ∂θ ∣∣∣∣ θ=[θ1, θ2, ..., θc] = ∂LCE ∂u ∣∣∣∣ u=[u1,u2, ...,uc] · ∂u ∂θ
= −1 c · ∂ (
∑c i=1 log eui∑c j=1 e uj )
∂u · ∂u ∂θ
= −1 c · ∂ (
∑c i=1 ui − c · log ∑c j=1 e uj )
∂u · ∂u ∂θ
= −1 c · (1− c · [e u1 , eu2 , ..., euc ]∑c j=1 e uj ) · z. (14)
Then we summarize the gradient magnitudes over all pixels and channels:
c∑ i=1 ∥∂LCE ∂θi ∥ = p∑ n=1 c∑ i=1 ∥∂LCE ∂uni · ∂u n i ∂θi ∥
= −1 c · ( p∑ n=1 c∑ i=1 ∥1− c · e uni∑c
j=1 e unj︸ ︷︷ ︸
output space
∥) · ( p∑
n=1 ∥zn∥)︸ ︷︷ ︸ feature space . (15)
The result indicates that the gradients of CE loss characterize the information in both feature space and output space. Similarly, for Dice loss LDice:
min θ∼[W , b] p∑ n=1 c∑ i=1 (1− 2y n i act(u n i ) yni + act(u n i ) ). (16)
Here we omit the details of softmax layer and use act to denote the activation function for simplicity. When c is large, the pixel-wise derivative can be approximated by:
∂LDice ∂θ ∣∣∣∣ θ=[θ1, θ2, ..., θc] = ∂LDice ∂act(u) · ∂act(u) ∂u · ∂u ∂θ
≈ ξ · [e u1 , eu2 , ..., euc ]
[act(u1)2, act(u2)2, ..., act(uc)2] · z,
(17)
where ξ is a constant term. Its gradient magnitudes can be written as: c∑
i=1
∥∂LDice ∂θi
∥ = p∑
n=1 c∑ i=1 ∥ ∂LDice ∂act(uni ) · ∂act(u n i ) ∂uni · ∂u n i ∂θi ∥
≈ ξ · ( p∑
n=1 c∑ i=1 ∥ e uni
act(uni ) 2︸ ︷︷ ︸
output space
∥) · ( p∑
n=1 ∥zn∥)︸ ︷︷ ︸ feature space ,
(18)
which proves that the proposition also holds true for Dice loss. 2.2. impacts on generalization error In this section, we prove the effectiveness of our method towards a tighter generalization error bound on the target domain and novel classes. Firstly, we analyze the underlying mechanism for the cross-domain distillation module. Let H be a hypothesis space of VC-dimension d, for h ∈ H, the correlations between the error on the target domain and the distance in gradient space across domains are established as [3, 19]:
ϵT (h) ≤ ϵ̂S(h) + 4
nl
√ (d log
2enl d + log 4 δ ) + Λ
+Div∇(ŨS, ŨT )+ 4
√ 4 log(2nu) + log( 4 δ )
nu ,
(19)
with probability at least 1 − δ. Here ϵT and ϵ̂S represent the true and empirically estimated error of the target and source domain, respectively. Div∇(ŨS , ŨT ) is the distance between data distributions ŨS and ŨT in gradient space. nl and nu denote the number of labeled and unlabeled samples. Λ, δ, and e are constants. It implies that constraining the gradient descent trajectory of the target domain to approximate the source domain’s, which reduces Div∇(ŨS , ŨT ), could lead to lower cross-domain generalization error. Furthermore, we demonstrate that the cross-class distillation module contributes to lower empirical error on novel classes from the multi-task learning perspective. Suppose that L is the empirical training loss and ∇θLq(θ) denotes its derivative w.r.t. class q. Given a set of anchor classes {ai}Ai=1 and a novel class q, with the first-order Taylor expansion, we have:
Lq(θ−µ·∆θ∗) = Lq(θ)−µ·∇θLq(θ)·∆θ∗+O(µ), (20)
where the optimization step ∆θ∗ is characterized by∑A i=1 ∇θLai(θ) +∇θLq(θ), µ is a small value. Then:
Lq(θ − µ·∆θ∗)− Lq(θ) = −µ · { ∥∇θLq(θ)∥2
+ A∑ i=1 [ ∇θLq(θ) · ∇θLai(θ) ]} +O(µ). (21)
It indicates that by enforcing the similarity between the gradients w.r.t. novel and anchor classes, we could drive the model to reduce the empirical loss on novel classes along optimization and thereby attain a well-generalizable solution. 3. implementation details  3.1. nuclei segmentation and recognition  3.1.1 datasets and preprocessing Accurate detection, segmentation, and classification of nuclei serve as essential prerequisites for various clinical and research studies within the digital pathology field [23]. Inconsistent taxonomy for nuclei categorization is common across different institutes, which results in the unmatched label sets among datasets. In this regard, we use PanNuke [17] and Lizard [22] as the source and target dataset, respectively. PanNuke contains 481 visual fields cropped from whole-slide images along with 189,744 annotated nuclei. It follows a categorization schema where nuclei are divided into five classes, including neoplastic, non-neoplastic epithelial, inflammatory, connective, and dead cells. We discard the “dead” class as it does not exist in most image patches. To ensure the dataset has a uniform data distribution, we use all images from the breast tissue to formulate the source dataset. Lizard consists of 291 image regions with an average size of 1016×917 pixels from the colon tissue and annotates 495,179 nuclei. It adopts a categorization schema different to PanNuke that there are six classes in total, i.e., neutrophil, eosinophil, plasma, lymphocyte, epithelial, and connective cells. We use the Dpath subset as the target dataset. For preprocessing, all the visual fields with divergent size are randomly cropped into image patches of 128×128 pixels. CutMix [70] is used to augment the target dataset. 3.1.2 network architectures and parameter settings We employ the widely used Hover-Net [23] architecture with a standard ResNet-50 backbone as the base model. The optimizer is Adam with a learning rate of 1e − 4 and (β1, β2) = (0.9, 0.999), and the batch size is set as 4. To supervise the classification and segmentation branches, we adopt a combined loss of CrossEntropyLoss + DiceLoss. λ in Eq. (8) and κ in Eq. (11) are empirically set to 1000 and 10, respectively. 3.1.3 evaluation metrics F1 score is a popular metric to evaluate classification performance. It measures both precision and recall harmonically. We report the class-averaged score to indicate the overall accuracy. Panoptic quality (PQ) [23] is a unified metric for the instance segmentation task which models the quality of both detection and segmentation results concurrently:
PQ = TP TP + 12FP +
1 2FN︸ ︷︷ ︸
Detection Quality
· ∑ (y,ŷ)∈TP IoU(y, ŷ)
TP︸ ︷︷ ︸ Segmentation Quality . (22)
where TP,FP,FN are the true positive, false positive, and false negative detection predictions, respectively. (y, ŷ) represents the pair of ground truth and predicted segmentation mask. IoU is the intersection over union score. 3.2. cancer tissue phenotyping  3.2.1 datasets and preprocessing Identifying distinct tissue phenotypes is an essential step towards systematic profiling of the tumor microenvironment in pathological examination [31]. Previous works are mostly limited to the discrimination of two classes of tissue: tumor and stroma [41], while recent studies argue that recognizing more heterogeneous tissues brings clinical value [33]. We therefore propose to perform adaptation from a dataset with only two categories of tissue to another dataset with several novel classes. In particular, we select images of tumor and stroma tissue from the CRC-TP [31] to form the source dataset. CRC-TP contains 20 H&E-stained colorectal cancer (CRC) slides obtained from 20 different patients. Region-level tissue phenotype annotations are provided by expert pathologists. To ensure a unique category label can be assigned to each image, patches are extracted at 20× magnification with the size of 150×150 pixels. The patch-wise tissue phenotypes are decided based on the majority of their content. Kather [33] is then regarded as the target dataset. It consists of 5000 150 × 150 pathology image patches sampled from 10 anonymized CRC tissue slides. Other than tumor and stroma tissue, Kather includes six novel tissue types, i.e., complex stroma, immune cells, debris, normal mucosal glands, adipose tissue, background, and thus poses an 8-class classification problem. 3.2.2 network architectures and parameter settings For experiments, we employ ResNet-101 as the image encoder and thereupon add two classification heads on top to perform 2-class and 8-class discrimination, respectively. During training, cross-entropy loss and Adam optimizer with learning rate 1e − 4 are used to optimize the model with a batch size of 4. λ and κ are set to 10 and 100. 3.3. skin lesion diagnosis  3.3.1 datasets and preprocessing Automatic fine-grained skin lesion recognition remains a global challenge in dermatology. By taking a step further than the basic benign/malignant differentiation, identifying the specific subtypes of lesions demonstrates significant diagnostic value [58]. We hereby assign a benign/malignant discrimination dataset as the source domain, and a fine-grained multi-disease dataset as the target domain. HAM10000 is a dermatoscopic image dataset collected from different populations and modalities [59]. After preprocessing procedures including histogram correction, sample filtering, and center crop, 10015 dermatoscopic images with lesions of seven diagnostic categories in total are provided. It contains four subtypes of benign lesions (melanocytic nevi (NV), benign keratinocytic lesions (BKL), dermatofibromas (DF), and vascular lesions (VASC)) and three subtypes of malignant ones (melanomas (MEL), basal cell carcinomas (BCC), and actinic keratoses intraepithelial carcinomas (AKIEC)). We use the face subset with only coarse two-class annotations as the source domain and the lower extremity subset with fine-grained seven-class annotations as the target domain. All images are randomly cropped to the size of 160× 160 pixels before being forwarded to the network. 3.4. overall experiment settings For all experiments, we implement our method with Pytorch and conduct training on a NVIDIA GeForce RTX 3090 GPU with 24GB of memory. Gradient backpropagation is performed for each mini-batch using BackPACK [12]. Following previous works in UDA [7], each dataset is randomly split into 80%/20% as the training/test sets. For novel classes in the target dataset, we sample few (5/10) samples with corresponding labels to formulate the support set. The remaining target data is left unlabeled. Data augmentation techniques such as rotation and horizontal/vertical flip are employed during training. Please refer to the source code for more details. It is noted that although from the technical perspective, skin lesion diagnosis is a multi-class classification problem similar to cancer tissue phenotyping, they differ largely in the task context. Specifically, skin lesion diagnosis is more
like an object recognition task where its decision is dominated by the local attributes of lesions, while cancer tissue phenotyping relies on the global structure of the whole pathology images, instead of focusing on a salient object. 4. additional experiment results  4.1. visualization We provide additional qualitative results on the three benchmarks. The comparison results shown in Fig. 5 demonstrate the superiority of our method to detect each nucleus and delineate its boundary, as well as differentiating nuclei of various types with their detailed biological features. The t-SNE visualization in Fig. 6 shows that our method could discover the underlying embedding structures of various classes even with very limited labeled data. 4.2. results with more annotations In this section, we compare our method with previous state-of-the-art approaches for cross-domain adaptation
when more labeled samples are available in the target domain. The results for nuclei segmentation and recognition with 30 labeled target samples are shown in Table 5. The overall improvements of our method under this setting are consistent with previous experiment results. It validates the effectiveness of our method under different levels of support. 4.3. extended experiments on diverse tasks We further evaluate our method on two medical image tasks beyond pathology analysis and one general visual recognition task, where the medical image tasks include pneumonia screening in radiology and diabetic retinopathy grading in fundus photography. For radiology analysis, we adopt covid-kaggle [51] and Chest-Montreal [11] for TADA from normal/pneumonia coarse screening to finegrained pneumonia diagnosis. For fundus, DDR [37] and APTOS19 [32] are used to construct a TADA setting with two novel classes (grade level 3, 4). In these settings, distribution shifts exist across domains due to differences in image acquisition protocols among multiple cohorts. For general visual task, we adopt OfficeHome [61] and evaluate on “Artist” and “Real-world” domains. Experiments are conducted in 10-shot regime and the corresponding results are presented in Table 6. Through comparison with SOTA methods, the effectiveness and broader applicability of our
method are proved. 4.4. extended key component analysis In Table 7, we demonstrate the effectiveness of our method’s key components. It complements the ablation study performed in the main text from a cumulative perspective. From the results, we observe that all the proposed modules are beneficial for improving the cross-domain adaptation performance. In particular, the employment of the cross-class distillation module contributes to a significant performance gain for target-private classes. For instance, it attains 3.48% and 2.18% improvements in terms of mF1* and mPQ* under 10-shot scheme. It verifies the effectiveness of our method to perform optimization trajectory distillation across domains and classes towards strong model generalization. 4.5. extended hyperparameter sensitivity analysis We further analyze the choices of hyperparameters and their impacts on model performance in Fig. 7. We vary the values of K and T , which denote the volumes of memory bank employed in the cross-domain/class distillation and historical self-distillation modules. The choice of τ in Eq. (6) which coordinates the identification of principle subspace is also studied. The results indicate that the choices of those hyperparameters do not have a significant influence as long as they are set within reasonable intervals. Compared with them, the choices of λ in Eq. (8) and κ in Eq. (11) demonstrate more importance and are required to be carefully decided. 4.6. robustness to support sample selection To evaluate the robustness of our method against the randomness during few-shot sample selection, we run the experiments for 10 times with different sets of labeled samples
in the target domain. The averaged results are presented in Table 8. It demonstrates that our method consistently outperforms the competing approaches under diverse settings, which indicates its strong robustness.