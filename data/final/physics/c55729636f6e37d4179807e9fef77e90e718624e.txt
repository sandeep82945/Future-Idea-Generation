Molecular property prediction is an important problem in drug discovery and materials science. As geometric structures have been demonstrated necessary for molecular property prediction, 3D information has been combined with various graph learning methods to boost prediction performance. However, obtaining the geometric structure of molecules is not feasible in many real-world applications due to the high computational cost. In this work, we propose a novel 3D pre-training framework (dubbed 3D PGT), which pretrains a model on 3D molecular graphs, and then fine-tunes it on molecular graphs without 3D structures. Based on fact that bond length, bond angle, and dihedral angle are three basic geometric descriptors corresponding to a complete molecular 3D conformer, we first develop a multi-task generative pre-train framework based on these three attributes. Next, to automatically fuse these three generative tasks, we design a surrogate metric using the total energy to search for weight distribution of the three pretext tasks since total energy corresponding to the quality of 3D conformer. Extensive experiments on 2D molecular graphs are conducted to demonstrate the accuracy, efficiency and generalization ability of the proposed 3D PGT compared to various pre-training baselines. 1 introduction Molecular property prediction is a foundational problem in drug discovery [45], materials science [3, 49] and bioinformatics [33, 50, 58]. Conventionally, in quantum chemistry, popular computational tools based on Density Functional Theory (DFT) [35] are used to compute a moleculeâ€™s geometry and quantum properties, e.g. energy of atoms. Then recent years have witnessed the success of machine learning, especially graph neural networks (GNNs) [8, 12] and graph transformer based methods [18, 53, 56], in molecular property prediction, since a molecule can be naturally represented by a graph, where nodes and edges represent atoms and their chemical bonds, respectively. As shown in Figure 1, existing learning-based methods can be roughly categorized into two groups based on the usage of 3D geometry of molecules. Especially, as the molecular properties are mostly determined by their 3D structures [6, 13], methods [11, 22, 60] that directly model the 3D structures of molecules, e.g., 3D conformers, have been proposed to further improve the performance compared to 2D methods. However, due to the high computational expensive of DFT-based tools, it tends to be a challenging problem to obtain sufficient labels for these learning based methods. Very recently, inspired by the success of pre-training and finetuning paradigm in natural language processing [7, 38] and computer vision [4, 14], researchers started to apply self-supervised learning (SSL) to molecular property prediction [16, 17, 27, 37, 43, 57]. The key to pre-training lies in pretext tasks design to make better use of the rich unlabeled molecule data, no matter 2D or 3D graphs. Then, existing works can also be categorized into 2D and 3D pre-train methods, according to the type of pretext tasks. For example, in [16], several node-level and graph-level prediction tasks directly from 2D molecular graphs are designed to pre-train GNN models, which are then fine-tuned on downstream tasks. In terms of 3D pretraining methods, [57] conducts SSL tasks by position denoising of 3D molecular structures at equilibrium to learn the molecular force field, which can help the 3D model predict properties more accurately. All these works have demonstrated the effectiveness of pre-training methods for molecular prediction, especially designing pretext tasks on 3D molecular structures. Although 3Dmolecular structures are necessary to achieve strong performance in molecular property prediction [10], obtaining 3D
ar X
iv :2
30 6. 07 81
2v 2
[ q-
bi o.
Q M
] 2
J ul
2 02
equilibrium structure, shown in Figure 1, still requires expensive DFT-based geometry optimization [15, 55]. Thus, even if we can obtain an accurate 3D GNN model by pre-training, prediction on downstream tasks can still be very slow, especially for large-scale real-world applications [15], since we need to compute 3D structure for each molecule before inference. In this work, to address this problem, we propose a novel 3D pre-train approach on existing unlabeled 3D molecular datasets and then fine-tune and predict on the molecules only with 2D molecular graphs. In this way, the proposed method can enjoy the benefits of both two worlds, i.e., high accuracy from pre-training on 3D molecular graphs, and high efficiency from removing the need for computing 3D structures in the fine-tuning/prediction stage. To be specific, we first design multiple generative pre-training tasks based on three attributes, bond length, bond angle, and dihedral angle, which are three basic local geometric descriptors that can be combined into a complete molecular 3D conformer[31]. In this work, we build our 3Dmultiple pretext tasks on the assumption that these three tasks are necessary and sufficient for effective encoding of 3D structure in molecular property prediction, then it remains to be a critical problem that fuse these three tasks in the pre-training stage. Intuitively, different tasks have distinct importance given a pre-trained dataset, and improper integration of multiple tasks may lead to ineffective or negative transfer to downstream tasks [46]. A possible solution is to search for an automated fusion scheme for these three pretext tasks, while the difficulty is that no supervision signal from downstream tasks can be provided. To tackle this problem, we design a surrogate metric based on total energy of all atoms in a molecule in pre-training stage that can supervise the weight allocation of each pre-text tasks, considering that it corresponds to a lowest-energy 3D conformer for a molecule [2, 31]. By automatically searching for the pre-task and optimizing the total energy in the pre-training stage, we can potentially encode more accurate molecular geometry information on the 2D molecular graph, which
will promise generalization benefits for various molecular property prediction tasks. Besides, to guarantee the prediction performance, we choose GPS [40] as our backbone, which is a hybrid architecture of GNN and Transformer. Then the proposed method is dubbed 3D PGT (Pre-trained Graph Transformer). To demonstrate the superiority of the proposed 3D PGT, we conduct extensive experiments on various scenarios. Here we highlight some results: a) On the well-known benchmark dataset, QM9 [39], 3D PGT not only improves the prediction performance compared to all baselines, but also enjoys high efficiency the same as methods directly operating on 2D molecular graphs; b) The performance gains in three kinds of downstream tasks demonstrate the strong generalization ability of the proposed 3D PGT; c) In a largescale application on HOMO-LUMO energy gap prediction in OGB benchmark [15] (3.37 million molecules for pre-training), where only 2D methods are feasible, the proposed 3D PGT achieves 10.6% relative MAE reduction compared to the same backbone without pre-training and outperforms all models from top solutions in the OGB leaderboard. To summarize, the contributions of this work are as follows:
â€¢ We propose a novel pre-training framework to encode 3D geometry with three important pretext tasks for molecular property prediction. To the best of our knowledge, we are the first to integrate these three tasks in a unifying manner for pre-training methods. â€¢ Further, based on important quantum chemistry knowledge, we design a surrogate metric by total energy, which serves as a supervision signal to search the adaptive weight of each pre-training task, and generalize the benefits to various downstream tasks. â€¢ Extensive experiments on various tasks demonstrate the superiority of the proposed 3D PGT in terms of accuracy, efficiency and generalization ability. 2 relatedwork  2.1 property prediction on molecular graph For property prediction on molecular graph, GNN has become an emerging research field which process it as a graph-level prediction task [47, 50]. After [8] demonstrated that ML models could be more accurate than hybrid DFT if explicitly electron correlated quantum data was available, [12] proposed a message passing framework for chemical prediction problems that are capable of learning their own features from molecular graphs directly, and was considered as the most general architectures for realizing GNNs. However, message passing based methods is weak in capturing long-range dependencies [40]. Complementary, the Graph Transformer based methods represented by Graphormer [56] which is directly build upon the standard Transformer realized the interaction between long-range nodes. Furthermore, EGT [18] uses global self-attention to update both node and edge representations, allowing unconstrained dynamic long-range interaction between nodes and improves the performance for the quantum-chemical regression task on the PCQM4Mv2 [15] dataset. GraphTrans [53] and GPS [40] regard GNN and Transformer as complementary, and explore the coexistence framework between them. At the same time, one important branch of improvement is to effectively use the geometric information contained in 3D conformers [2, 48]. There is a series of work focus on using relative 3D information which can be derived based on absolute Cartesian coordinates, such as bond length and bond angle [22]. GemNet [11] further capture the information from dihedral angle to define all relative atom positions uniquely. Not limited in Cartesian coordinates, SphereNet [28] propose a generic framework of 3D graph network (3DGN), and design the spherical message passing to realize 3DGN in the spherical coordinate system. However, although 3D information has been proved to be valuable for the prediction of molecular properties, the generation of 3D conformer requires DFT-based geometric optimization which needs expensive calculation. This makes it infeasible to explicitly calculate the molecular structure for large-scale datasets. 2.2 pre-training on molecular graph The general pipeline of pre-training is to first pre-train the model on a large dataset through proxy tasks, and then conduct further parameter fine-tuning on specific downstream tasks based on corresponding supervision signals. The self-supervised pre-training on graph is usually designed to learn self-generated targets from the structure of the molecules, such as masked node reconstruction and context prediction [16]. There are also works use motif prediction as a pre-training task on 2D molecular graph to improve the performance of property prediction [41]. Considering the calculation cost of 3D geometry and its importance for molecular property prediction task, a series of work proposed to pre-train a graph encoder which encode implicit 3D information in its latent vectors by pre-training on publicly available 3D molecular structures. They first conduct pre-training on the dataset with 3D structure through designing proxy task, and then transfer the pre-trained model to the downstream task which only contained 2D topology for fine-tuning. Similar to the 3D models which contained 3D geometry as input, the designed pre-training task designed should also respect the symmetries of rotation and translation. For example, Liu et al. [27] and StÃ¤rk et al. [27] used mutual information between 2D and 3D views for molecular pretraining, therefore the GNN is still able to produce implicit 3D information that can used to inform property predictions. Zhu et al. [59] proposed a unified 2D and 3D pre-training which jointly leverages the 2D graph structure and the 3D geometry of the molecule. GEM [11] proposes a bond-angle graph and self-supervised tasks which use large-scale unlabelled molecules with coarse 3D spatial structures which can be calculated by cheminformatics tools such as RDKit. Inspired by the encoding method of Graphormer for 2D molecular graph, Transformer-M [29] further encodes 3D spatial distance into attention bias, which can take molecular data of 2D or 3D formats as input. Different from existing works, we design multiple generative pretext tasks based on 3D conformer, and fuse these tasks automatically by an interesting and useful supervision signal, i.e., the total energy of molecules. 3 method  3.1 problem formulation Let ğº2D = (ğ‘‰ , ğ¸) denote a 2D molecular graph with atom attributes xğ‘£ for ğ‘£ âˆˆ ğ‘‰ and bond attributes eğ‘¢ğ‘£ for (ğ‘¢, ğ‘£) âˆˆ ğ¸, 3D molecular graph refers to ğº3D = (ğ‘‰ , ğ¸, P) which contains 3D Cartesian coordinates P âˆˆ R |ğ‘‰ |Ã—3 for all atoms. The coordinates P contained in the 3D conformer is valuable information for the graph encoder ğ‘“ğœƒ (Â·) in molecular property prediction, each conformer requires the calculation by DFT-based tools for several hours per CPU-core [44]. As generic pre-training pipelines, 3D pre-training with geometry for molecular representation has two stages: In the pre-training stage, the proxy task Lpre is designed to learn the self-generated targets from the publicly available 3D molecular graph ğº3D; then during the finetune stage, the pre-trained encoder ğ‘“ğœƒ âˆ— (Â·) is finetuned according to specific supervision signals on downstream tasks, which only includes 2D molecular graphs. 3.2 automated fusion framework for multiple 3D Pre-training Tasks
In this work, we propose 3D PGT, an automated fusion framework that contains multiple generative 3D pre-training tasks to obtain an effective pre-trained 2D graph encoder ğ‘“ğœƒ âˆ— (Â·). 3D PGT focuses on 1. Designing multiple generative pre-training tasks that can benefit downstream tasks where 3D information is not available; 2. Bridging the gap between 3D generative pre-training tasks and downstream property prediction, allowing a wider range of downstream tasks to benefit from pre-training. In the following, we first present an overview of 3D PGT, and propose three generative pre-training tasks concerning 3D conformer generation. Then, to better fuse multiple pre-training tasks instead of purely average pre-training, we introduce an automated fusion framework with a surrogate metric to search the weight of each generative task during the pre-training stage. Finally, we summarize the variants for leveraging multiple conformers and searching the architecture of the backbone. Overview of 3D PGT. In general, 3D PGT focuses on designing the 3D pre-training framework to learn the robust transferable knowledge from ğº3D and then generalize to downstream tasks which consist ofğº2D. Different from existing contrastive learning based methods [27, 43], 3D PGT aims to encode geometric priors only through single-model pre-training. As shown in Figure 3, 3D PGT first splits the 3D conformer optimization into three generative tasks: bond length, bond angle and dihedral angel. By reconstructing these local descriptors that can fully describe the 3D conformer, the encoder could implicitly generate and encode 3D information in its latent vectors, which can better reflect certain molecular properties [59]. Considering the weight distribution problem of these three pre-training tasks, we design a pre-training surrogate metric to dynamically adjust the weights of each generative task, and conduct the pre-training of the model as a bi-level optimization problem:
min ğœ†1,Â· Â· Â·,ğœ†ğ‘› H (ğ‘“ğœƒ âˆ— (ğº)), s.t.ğœƒâˆ— = argmin ğœƒ ğ‘›âˆ‘ï¸ ğ‘–=1 ğœ†ğ‘–Lğ‘– (ğ‘“ğœƒ (ğº)), (1)
where ğœ†ğ‘– is the lossweight for pre-training taskLğ‘– . As a pre-training surrogate metric, H is used as a medium to correlate conformer generation with downstream property prediction tasks, thus filling the gap between self-supervised pre-training tasks and downstream supervised tasks, so that the geometric priors can be better generalized to downstream tasks with different supervision signals. The overall framework of 3D PGT is shown in Figure 2. 3.2.1 3d generative pre-training tasks. Generative pre-training task enables the model to understand the DFT based geometry optimization process of molecules from 2D topology to 3D geometry. Since molecular geometry is determined by the quantum mechanical behavior of the electrons, the generative task indirectly learns the prediction of quantum chemical properties by learning the generation of 3D conformers. In this work, we design multiple generative 3D pre-training tasks based on molecular structure generation, including the prediction of bond length, bond angle, and dihedral angles, which are complementary local geometric parameters that can elucidate a 3D conformer. As the distance between the equilibrium nuclei of two bonded atoms, bond length is the basic configuration parameter for understanding molecular structure [24]. We first take bond length prediction as one of the generative pre-training tasks and define the loss function as follow:
Llength(ğ¸) = 1 |ğ¸ | âˆ‘ï¸ (ğ‘–, ğ‘— )âˆˆğ¸ (ğ‘“length(h (ğ¿) ğ‘– ,h(ğ¿) ğ‘— ) âˆ’ ğ‘™ğ‘– ğ‘— )2, (2)
where, h(ğ¿) ğ‘– and h(ğ¿) ğ‘—
denotes the representation of atom ğ‘– and ğ‘— which are encoded from ğ‘“ğœƒ (Â·), ğ‘“length(Â·) is a network that predicts the bond length, ğ‘™ğ‘– ğ‘— denotes the length of the bond (ğ‘–, ğ‘— ) âˆˆ ğ¸. At the same time, the bond angle and dihedral angle which can be understood as the local spatial description of molecular geometry
are the complementary information of bond length. These two prediction tasks could be designed as:
Langle(ğ´) = 1 |ğ´| âˆ‘ï¸ (ğ‘–, ğ‘—,ğ‘˜)âˆˆğ´ (ğ‘“angle(h (ğ¿) ğ‘– , h(ğ¿) ğ‘— , h(ğ¿) ğ‘˜ ) âˆ’ ğ›¼ ğ‘—,ğ‘–,ğ‘˜ )2, (3)
Ldihedral(ğ·) = 1 |ğ· | âˆ‘ï¸ (ğ‘–, ğ‘—,ğ‘˜,ğ‘š)âˆˆğ· (ğ‘“dihedral(h (ğ¿) ğ‘– , h(ğ¿) ğ‘— , h(ğ¿) ğ‘˜ , h(ğ¿)ğ‘š ) âˆ’ ğœ™ğ‘˜,ğ‘–, ğ‘—,ğ‘š)2, (4)
where ğ´ denotes the set of bond angles and ğ· denotes the set of dihedral angles. ğ›¼ğ‘–, ğ‘—,ğ‘˜ and ğœ™ğ‘˜,ğ‘–, ğ‘—,ğ‘š represent the bond angle formed by node ğ‘–, ğ‘—, ğ‘˜ and the dihedral angle involving node ğ‘–, ğ‘—, ğ‘˜,ğ‘š. Their value ranges are [0, ğœ‹] and [0, 2ğœ‹]. ğ‘“angle and ğ‘“dihedral are two prediction networks
However, with the number of neighbors |N |, the O(|N |2) and O(|N |3) computational complexity of bond angle calculation and dihedral angle calculation will cause a large amount of time and memory consumption during pre-training. Inspired by [42], we propose a task variant that directly predicts the sum of cosine values of bond angle and dihedral angle as follows:
Langle(A) = 1 |A| âˆ‘ï¸ ğ‘–âˆˆV ( âˆ‘ï¸ (ğ‘—,ğ‘˜)âˆˆAğ‘– ğ‘“angle(h (ğ¿) ğ‘– , h(ğ¿) ğ‘— , h(ğ¿) ğ‘˜ ) âˆ’ Î˜ğ‘– )2, (5) Ldihedral(D) = 1 |D| âˆ‘ï¸ (ğ‘–, ğ‘— )âˆˆE ( âˆ‘ï¸ (ğ‘˜,ğ‘š)âˆˆDğ‘– ğ‘— ğ‘“dihedral(h (ğ¿) ğ‘– , h(ğ¿) ğ‘— , h(ğ¿) ğ‘˜ , h(ğ¿)ğ‘š ) âˆ’ Î¦(ğ‘–, ğ‘— ))2, (6)
where Ağ‘– represents the angle set formed by node ğ‘– , Dğ‘– ğ‘— represents the dihedral angle set with ğ‘’ğ‘– ğ‘— as the common rotation axis. The calculation details of Î˜ğ‘– and Î¦(ğ‘–, ğ‘— ) which denotes the sum of cosine values of Ağ‘– and Dğ‘– ğ‘— are described in Appendix B.1. 3.2.2 fusion supervised by a surrogate metric. In order to integrate the multiple generative tasks we defined, we need a supervision signal to optimize the weights of each pretraining task. Given access to the downstream task labels, we can explicitly use the performance on the downstream task as an objective function to guide weight tuning. However, considering the variety of molecular property prediction tasks, searching ğœ†ğ‘– as a hyper-parameter can be highly expensive. Therefore, designing a generalized surrogate metric for searching these weights is necessary. The total energy of a molecule is represented by the sum of the energy of each atomic domain and the energy of electrostatic interactions between the domains [21]. As mentioned above, the geometry optimization of DFT is to search the local minima on the potential energy surface [2], as shown in Figure 3. The basic functional form of potential energy inmolecularmechanics includes the bonded terms for interactions of atoms and the nonbonded terms that describe the long-range electrostatic and van der Waals forces, which means that the total energy of a molecule can reflect its geometric information. Considering that the total energy ğ¸total as an attribute of 3D conformer can be acquired along with conformer generation, we design a graph-level prediction task based on the ğ¸total, which can be expressed as:
Lğ¸total (ğ‘“ğœƒ (ğº)) = (ğ‘“ğœƒ (ğº) âˆ’ ğ¸total) 2 . (7)
Here, we use Lğ¸total as the surrogate metric to optimize ğœ†ğ‘– , and due to the association between 3D geometric information and molecular properties, Lğ¸total (ğº) can be used to supervise the fusion of these generative pre-training tasks so that the geometric prior obtained by
pre-training is also generalized for downstream property prediction tasks. However, for the bi-level optimization problem in equation (1), computing the gradient ofLğ¸total to update ğœ†ğ‘– is very expensive [36]. Inspired by [9], we use mate-gradients to optimize this bi-level problem. By unrolling the training procedure, the meta-gradient âˆ‡meta{ğœ†ğ‘– } can be expressed as:
âˆ‡meta{ğœ†ğ‘– } : = âˆ‡{ğœ†ğ‘– }Lğ¸total (ğ‘“ğœƒğ‘‡ (ğº)) (8) = âˆ‡ğ‘“ğœƒğ‘‡ Lğ¸total (ğ‘“ğœƒğ‘‡ (ğº)) Â· âˆ‡ğœƒğ‘‡ ğ‘“ğœƒğ‘‡ (ğº)âˆ‡{ğœ†ğ‘– }ğœƒğ‘‡ , (9)
where ğœƒğ‘‡ denotes the encoderâ€™s parameters ğœƒ at step ğ‘‡ , which is depends on the task weights {ğœ†ğ‘– }. Thus, the gradient descent performed on {ğœ†ğ‘– } can be achieved bymeta-gradientâˆ‡meta{ğœ†ğ‘– } as {ğœ†ğ‘– }âˆ’ ğœ‚âˆ‡meta{ğœ†ğ‘– } , where ğœ‚ is the learning rate for outer optimization. At the same time, inspired by DARTS [25], we only perform one step gradient descent on ğœƒ and update {ğœ†ğ‘– } each iteration, which means {ğœ†ğ‘– } is dynamic during the pre-training stage and adjusts between [0, 1]. The calculation details of âˆ‡meta{ğœ†ğ‘– } can be referred to [9]. 3.3 further improvements  3.3.1 pre-training by multiple conformers. As mentioned in Section 3.1, 3D molecular datasets usually calculate the conformer with the lowest energy. However, leveraging structural information of multiple conformers could bring additional benefits [27, 43]. Therefore, we consider introduce multiple conformers {Pğ‘
ğ‘– }ğ‘âˆˆ{1...ğ¶ } of the same molecule graph ğºğ‘– in the
pre-training datasets, and repeat the lowest energy conformer if the conformer number of a molecule is fewer than ğ¶ . For the 3D pre-training in our framework, we here simply consider it as a data augmentation and avoid the pipeline changes of pre-training. 3.3.2 architecture search of graph transformer. In addition to using the surrogate metricH to search the weight of each pre-training task, we also search the architecture of pretraining backbone. Based on the hybrid Graph Transformer structures which combined the local message passing module and global attention module, we build a search space that includes the above modules to search the backbones for different pre-training datasets. Specifically, in each layer of the graph encoder ğ‘“ğœƒ (Â·), the search space of operations Oğºğ‘‡ includes 3 operations: local message passing, global attention and a hybrid operation through a Feed Forward Network (FFN). We then relax the discrete selection of operation by a weighted summation of all possible operations, and use a differentiable search algorithm based on Gumble-Softmax [19]. The details of the architecture search are described in Appendix B. 4 experiments In this section, we conduct various experiments to demonstrate the effectiveness of the proposed 3D PGT. As explained in Introduction, we aim to address the scenario where only 2D molecular graphs are available for prediction, thus we can avoid the huge computational cost of generating 3D conformer for each molecule. Thus in the experiments, we pre-train using subsets of 3D molecular structure datasets, and then fine-tune the models in downstream tasks of 2D datasets or 3D datasets while ignoring the 3D structures. Table 1: Results for quantum properties prediction in QM9. The evaluation metric is MAE (Smaller is better). The compared methods include 2D models without pre-training, pre-training baselines, and the 3D model SMP. True 3D means to input the ground truth 3D structure, and RDkit means to input the structure calculated by RDkit. The best performance of each target is marked in bold. Target 2D Model Pre-training Baselines 3D SMPPNA GPS GraphCL AttrMask GPT-GNN GraphMVP 3D Infomax ğ¸Total 3D PGT RDKIT True 3D
ğœ‡ 0.4133 0.4087 0.3937 0.4626 0.3975 0.3489 0.3507 0.3927 0.3409 0.4344 0.0726 ğ›¼ 0.3972 0.3884 0.3295 0.3570 0.3732 0.3227 0.3268 0.3514 0.3121 0.3020 0.1542 ğ»ğ‘‚ğ‘€ğ‘‚ 82.10 81.19 79.57 80.58 93.11 68.62 68.96 78.28 68.24 82.51 56.19 ğ¿ğ‘ˆğ‘€ğ‘‚ 85.72 84.86 80.81 84.93 99.84 70.23 69.51 81.26 69.73 80.36 43.58 GAP 123.08 121.17 120.08 116.21 131.99 101.84 101.71 112.37 101.53 114.24 85.10 R2 22.14 21.78 21.84 29.23 29.21 17.03 17.39 21.86 16.89 22.63 1.510 ZPVE 15.08 12.29 12.39 25.91 11.17 7.958 7.960 18.28 7.924 5.180 2.690 ğ‘ğ‘£ 0.1670 0.1618 0.1422 0.1587 0.1795 0.1287 0.1306 0.1507 0.1217 0.1419 0.0498
Here we briefly explain the organization of our experiments. Firstly, we evaluate the proposed 3D PGT on popular benchmark dataset,QM9 [39] , for quantum chemistry properties. Then broader downstream applications, including binary property classification, regression property, and drug-target affinity prediction, are designed to evaluate the generalization/transfer ability of the 3D PGT. Further ablation studies are conduct to show the importance of each design modules of our method. Finally, more interestingly, we apply 3D PGT to property prediction in a large-scale molecular dataset, PCQM4Mv2 [32], from the famous large-scale open graph benchmark (OGB) [15], where 3D structures are only given in training dataset, to justify the practical values of the problem we try to address in this work, as well as the technical contributions. Considering the different settings of the designed experiments, we give the introduction of experimental setups, including datasets, evaluation metrics, and baselines, in the corresponding subsections. And more detailed information are given in Appendix A and ? ?. Implementation of 3D PGT.We choose GPS [40] as the Graph Transformer for pre-training due to its state-of-the-art performance on OGB-LSC [15]. As mentioned in Section 3.3.2, we further search the architecture by the surrogate metric Lğ¸total , the details are described in Appendix ? ?. To implement 3D PGT and reproduce the results, the code is provided as an anonymous link 1. Datasets.We first explore the performance on eight quantum properties prediction of QM9 [39], which contains 134k molecules with a single conformer. Following the experimental setup of mainstream 3D pre-training work [43], we randomly select 50k molecules with geometric information from QM9 for pre-training. Then, we pick another 50k molecules from the rest and mask their 3D structures for model fine-tuning. We use the scaffold splits with an 8/1/1 ratio and report the Mean Absolute Error (MAE) of 8 quantum chemical properties in the test dataset. Baselines. As the SOTA performance on molecular tasks, we first select PNA [5] as the 2D model for comparison. It also includes GPS [40], the Graph Transformer that achieved SOTA on the OGB challenge [15] which is also the backbone of our 3D PGT. At the
1https://github.com/LARS-research/3D-PGT
Figure 4: The total inference time and performance ranking of different methods for ğ»ğ‘‚ğ‘€ğ‘‚ prediction. same time, we compare the most well-known pre-training methods, including AttrMask [16], GPT-GNN [17], GraphCL [1], GraphMVP [27] and 3D Infomax [43]. The backbone and hyperparameter settings of the above pre-training methods follow their original settings. We design a baseline that directly uses the total energy prediction as a pre-training task, so as to prove the significance of using total energy as a surrogate metric by comparison. We also chose the SMP [60] based on the 3D Graph Network framework as a 3D model for comparison. The configuration of SMP includes the real 3D structure calculated by DFT from the QM9 dataset; and the relatively rough 3D structure calculated based on RDKit [23]. 4.1 quantum chemistry properties prediction Results. The compared results are shown in Table 1. It can be seen that 3D PGT achieves better or competitive performance compared to all baselines. First, we can find that our 3D pre-training framework brings an average 17.7% MAE reduction compared with the GPS backbone, while significantly outperforming the 2D pretraining methods. It is obvious that the improvement brought by the pre-training without geometry in GraphCL is limited, and the same limitation is also reflected in the pre-training which uses energy as
the only optimization objective. Besides, the latest two pre-training models on molecular 3D structures, i.e., GraphMVP and 3D Informax, achieve evident performance improvement compared others only pre-training on 2D molecular graphs, which verifies the usefulness of 3D geometry in molecular prediction. Then the further improvement of our 3D PGT compared GraphMVP and 3D Infomax demonstrates the effectiveness of our approach. It is clear that SMP achieves the best performance when given the 3D structures in the test dataset, while notably that our proposed 3D PGT beat SMP with coarse 3D information in 6 targets out of 8, which indicates the advantage of this 3D pre-training and fine-tuning paradigm. In order to explicitly analyse the efficiency comparison of 2D, 3D models and pre-trained models, we statistics the total inference time and performance ranking of all baselines on the test set to analyze the efficiency between different methods, the result of HOMO prediction is shown in Figure 4. It can be seen that the 3D Pre-training based methods achieve a better trade-off between inference time and performance, especially 3D PGT. Although SMP using explicit ground truth 3D information has obvious advantages in predicting molecular properties, when the rough 3D information calculated by RDKIT is input, its performance is lower than that of 3D pre-training methods, which means that it is difficult for 3D models to balance computational efficiency and performance. 4.2 generalizing to different downstream tasks Datasets. In addition to predict the quantum chemical properties which is closely related to molecular geometry, we further generalize the downstream tasks to pharmacology, physical chemistry and biophysics, which only measured 2D structures of molecules. Following the experimental settings in [27], we randomly select 50k molecules in GEOM [2] with single conformer for pre-training, and finetune on 8 mainstream binary classification tasks and 6 classification tasks. These downstream datasets are all in the low-data regime and we describe their details in Appendix. Baselines. Following the baseline chosen by [27], in addition to the well-performing backbone GIN [54] and GPS [40], we also selected two 2D pre-training baselines, AttrMask [16] and ContextPred [16]; two predictive pre-training tasks DistancePred [59] and EnergyPred and the latest SOTA solution GraphMVP [27] and 3D Infomax [43]. Results of MoleculeNet Benchmark.MoleculeNet is a popular benchmark for molecular property prediction. We first compare 3D PGT with other baselines on eight binary property prediction tasks. The performance is shown in Table 2, where the best results are marked in bold. It can be seen that 3D PGT outperforms other baselines on most of these downstream tasks, which means our method can generalize the benefits of our pre-training framework to a broader range of downstream tasks, even though most of these tasks have only a small number of samples. We observe that 3D PGT does not achieve the best performance on Tox21 and MUV tasks, which is mainly because the GPS itself as the backbone is easy to overfit on these datasets. However, it is certain that compared to GPS, 3D PGT can still achieve stable performance gains through pre-training. Results of regression and drug-target affinity tasks. To further confirm whether 3D pre-training can help in a wider range of downstream tasks, we organized additional experiments on 4 additional molecular property regression tasks and 2 Drug-Target Affinity (DTA) tasks. Different from the prediction of the molecular properties themselves, the DTA task is to predict the affinity score between the molecular drug and the target protein. As shown in Table 3, the results show that 3D PGT is still competitive in these 6 regression tasks, and it also proves that 3D Pre-training can help in DTA tasks. 4.3 ablation studies The effect of searched adaptive weight for multiple tasks. In Section 3.2, we propose a surrogate metric based on total energy to search the adaptive weight of each generative pre-training task. To verify its effectiveness, we design an ablation study by pre-training a variant of average pre-training. We compared the two methods of average training and the weight search, the results in Figure 5 demonstrate that the searched weights lead to greater benefits on various downstream tasks. And the results of the six regression tasks also reached the same conclusion, as shown in Figure 7. The influence of pre-training dataset sizes. From Figure 5, it can be seen that for most downstream tasks, the performance increases with the amount of pre-trained data, although there is a marginal effect. However, on Tox21 and Sider, when the pre-training dataset
is further increased, the benefits of pre-training will decrease. One possible reason is that the backbone of GPS itself exhibits overfitting on the two data sets, and further injection of prior knowledge would not alleviate it [46]. Number of conformers for pre-training. For the multiple conformers of a single molecule, we verify whether useing these conformers can benefit the downstream task performance, as shown in Figure 6. The experiment shows that adding conformers for pre-training within a certain range can bring further pre-training benefits. However, consistent with the findings of previous work [1, 27, 43], we observe that there is a bottleneck in the improvement brought by adding more conformers. One accepted conclusion is that the top-5 conformers sampled according to the energy are sufficient to cover 80% of the equilibrium state, and further addition
of conformers cannot supplement more abundant geometric prior for downstream tasks. As discussed in Section 4.3, we observe that the GPS backbone is prone to overfitting on these two few-shot datasets, and the results show that further introducing too many geometric priors may not lead to better gains in this case. 4.4 pre-training on large-scale dataset Datasets. As the graph-level track of OGB-LSC [15], PCQM4Mv2 is a quantum chemistry dataset under the PubChemQC project [32]. The dataset contains a total of 3.74 million molecules, of which the 3D geometric information of 3.37 million training samples is obtained by DFT optimization. We adhered to the default trainvalidation split provided by OGB, and the test set was reserved for the competition and leaderboard and not publicly disclosed. In order
to approach the large-scale virtual screening scenario, the challenge [15] does not provide 3D conformers of the valid dataset and test dataset, and requires the property inference of 150k molecules to be completed within 4 hours using a single GPU, which means that it is not feasible to calculate the geometry of all test samples in the inference stage. Therefore, existing 3D GNN, e.g., SMP, can not work on this challenge due to the expensive computation cost of conformer generation. Baselines. Because the label of test datasets is officially hidden, we compared the results of validation with the top-tier method on the OGB leaderboard 2, which includes GRPE [34], TokenGT [20], EGT [18] , GPS [40], GEM-2 [26], Vis-Net [52] and TransformerM [29]. In addition, we also compared GPS++ [30], the winner solution at OGB LSC@ NeruIPS 2022 Challenge.Note that we only report the performance of single models from these solutions for fair comparisons, though it is clear that various engineering tricks,
2https://ogb.stanford.edu/docs/lsc/leaderboards/#pcqm4mv2
like ensemble, can be applied to further improve the performance of all methods including our 3D PGT. Results. The results of validation MAE are shown in Table 4. First, compared with the existing GNNs and Graph Transformers which do not consider 3D geometry information, 3D PGT has been significantly improved by introducing generative pre-training tasks. For GPS, 3D PGT has achieved 10.6% relative MAE reduction by the designed pre-training framework. Our 3D PGT outperforms the champion solution GPS++ in terms of single-model performance, proving the advantage of our pre-training framework while using the same backbone. 5 conclusion and futurework In this work, we proposed 3D PGT, a 3D pre-training framework which focus on incorporating 3D information for benefiting the molecular property prediction when the 3D structures is unavailable. In 3D PGT, we designed multiple generative pre-training tasks which can bring geometric prior to finetune stage. To better integrate these pre-training tasks and make their benefits generalize, we designed a surrogate metric of pre-training to search the adaptive weight of each pre-task. The experiment we designed proves that the potential geometric prior is not only beneficial to quantum chemical property prediction, but also to the prediction in pharmacology, physical chemistry and biophysics, etc. Moreover, 3D PGT outperforms all baselines from top solutions for large-scale molecular prediction in OGB leaderboard. acknowledgment Q. Yao is supported by NSF of China (No. 92270106). a dataset details a.1 pre-training datasets with 3d geometry Following themainstream experimental setup, we use three datasets containing 3D information for pre-training, and the detailed parameters are shown in Table 6. The three datasets are:
â€¢ QM9 [39] contains 134k molecules carrying 3D coordinates, each containing only one low-energy conformer. The largest atoms in QM9 are just nine heavy atoms, and each molecule is annotated with 12 quantum mechanical features. â€¢ GEOM-Drugs [2] contains 304kmolecules related to biology and pharmacology, and each molecule contains multiple 3D conformers, and Gibbs free energy and integrated energy are annotated as regression targets. The entire dataset contains 16 elements in total. â€¢ PCQM4Mv2 [15] contains 3.74m molecules with HOMOLUMO energy gap annotated as regression targets, it is a quantum chemistry dataset originally curated under the PubChemQCproject [32]. A total of 3.37m samples of low-energy conformers in the data set are annotated, while the remaining molecules that only contain 2D structures will be used as the validation set and the test set for the competition. b further method details Due to space limitations, the baseline details, technical details, and additional relationship study results compared in the experiment can be seen here: https://github.com/LARS-research/3D-PGT/blob/ main/Supplementary_Appendix.pdf
B.1 Computational Acceleration of Bond Angles and Dihedral Angles
Due to the high computational complexity of bond angles and dihedral angles, we reduce the computational complexity of bond angle and dihedral angle to linear time complexity, and the search of bond angle and dihedral angleâ€™s node index is replaced by the traversal of the node set ğ‘‰ and the edge set ğ¸. Inspired by the Runtime Geometry Calculation (RGC) [51] which directly calculates the geometric information from the direction unit which only sums the vectors from the target node to its neighbors once, we design two loss functions based on the sum of cosine values of bond angle and dihedral angle. RGC calculates the sum of bond angleâ€™s cosine values as follows:
Â®ğ‘¢ğ‘– ğ‘— = Â®ğ‘Ÿğ‘– ğ‘— âˆ¥Â®ğ‘Ÿğ‘– ğ‘— âˆ¥ , Â®ğ‘¢ğ‘–ğ‘˜ = Â®ğ‘Ÿğ‘–ğ‘˜ âˆ¥Â®ğ‘Ÿğ‘–ğ‘˜ âˆ¥ , (10)
Î˜ğ‘– = ğ‘ğ‘–âˆ‘ï¸ ğ‘—=1 ğ‘ğ‘–âˆ‘ï¸ ğ‘˜=1 cosğ›¼ ğ‘—ğ‘–ğ‘˜ = ğ‘ğ‘–âˆ‘ï¸ ğ‘—=1 ğ‘ğ‘–âˆ‘ï¸ ğ‘˜=1 âŒ© Â®ğ‘Ÿğ‘– ğ‘— , Â®ğ‘Ÿğ‘–ğ‘˜ âŒª , (11)
where Â®ğ‘Ÿğ‘– ğ‘— is the vector from node ğ‘– to its neighboring node ğ‘— . Record Â®ğ‘¢ğ‘– ğ‘— as the unit vector of Â®ğ‘Ÿğ‘– ğ‘— and Â®ğ‘£ğ‘– as the sum of all unit vectors from node ğ‘– , Â®ğœ” ğ‘—ğ‘– denotes the vector rejection RejÂ®ğ‘¢ğ‘– ğ‘— (Â®ğ‘£ğ‘– ), which represents the vector component of Â®ğ‘£ğ‘– perpendicular to Â®ğ‘¢ğ‘– ğ‘— . Î˜ğ‘– denotes the sum of cosine values of ğ›¼ ğ‘—ğ‘–ğ‘˜ , which denotes the angle formed by node i and two of its neighboring nodes ğ‘–, ğ‘— . For the sum of dihedral
angleâ€™s cosine values, RGC is expressed as: Â®ğ‘£ğ‘– = ğ‘ğ‘–âˆ‘ï¸ ğ‘—=1 Â®ğ‘¢ğ‘– ğ‘— , Â®ğœ”ğ‘– ğ‘— = RejÂ®ğ‘¢ğ‘– ğ‘— (Â®ğ‘£ğ‘– ) = Â®ğ‘£ğ‘– âˆ’ âŒ© Â®ğ‘£ğ‘– , Â®ğ‘¢ğ‘– ğ‘— âŒª Â· Â®ğ‘¢ğ‘– ğ‘— , (12)
Î¦(ğ‘–, ğ‘— ) = ğ‘ğ‘–âˆ‘ï¸ ğ‘—=1 ğ‘ğ‘–âˆ‘ï¸ ğ‘˜=1 cosğœ‘ğ‘šğ‘– ğ‘—ğ‘› = âŒ© Â®ğœ”ğ‘– ğ‘— , Â®ğœ” ğ‘—ğ‘– âŒª , (13)
where, the direction unit Â®ğ‘£ğ‘– is the sum of all unit vectors from node ğ‘– to its all neighboring nodes ğ‘— , Â®ğœ” ğ‘—ğ‘– denotes the vector rejection RejÂ®ğ‘¢ğ‘– ğ‘— (Â®ğ‘£ğ‘– ), which represents the vector component of Â®ğ‘£ğ‘– perpendicular to Â®ğ‘¢ğ‘– ğ‘— , termed as the vector rejection. Take Î˜ and Î¦ as target ,we design two loss functions based on the sum of cosine values of bond angle and dihedral angle as shown in Section 3.2. B.2 Supplementary ablation study We further design an ablation study on PCQM4Mv2 to verify the impact of each module in 3D PGT. From the results in Table 5, we can summarize that: a) The backbone which is combined with local message passing and global attention module has more obvious performance advantages. b) The single generative pre-training task only focuses on the reconstruction of a local descriptor. Combining them can bring more significant pre-training benefits. c). The effectiveness of searched adaptive weights has been clearly verified. c experiments details We report the detailed hyperparameters setup for pre-training in Table 7. At the same time, the hyperparameter search space during finetune in all downstream tasks is shown in Table 8. In addition, in order to facilitate the implementation of various GNN variants, we use the popular GNN library: PYG (Pytorch Geometric) (version 2.0.1). For pre-training on different datasets, we set the max epoch number as Table 7 and stop pre-training when the validation loss does not improve for 10 consecutive epochs.